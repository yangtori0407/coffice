<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.coffice.app.posts.board.BoardDAO">
  	<insert id="add" parameterType="BoardVO">
  		INSERT INTO BOARD VALUES(NULL, #{boardTitle}, #{userId}, 0, #{boardContents}, now(), 0, null)
  	</insert>
  	
  	<insert id="addComment" parameterType="CommentVO" useGeneratedKeys="true" keyProperty="commentNum">
  		INSERT INTO COMMENT VALUES(NULL, #{boardNum}, #{userId}, #{commentContents}, 0, 0, now(), 0);
  	</insert>
  	
  	<insert id="addReply" parameterType="CommentVO" useGeneratedKeys="true" keyProperty="commentNum">
  		INSERT INTO COMMENT VALUES(NULL, #{boardNum}, #{userId}, #{commentContents}, #{commentP}, 0, now(), 1);
  	</insert>
  	
  	<select id="getList" parameterType="Pager" resultType="BoardVO">
  		SELECT * FROM BOARD
  		<include refid="search"></include>
  		ORDER BY BOARD_NUM DESC
  		LIMIT #{startNum}, #{page}
  	</select>
  	
  	<select id="getTotalCount" parameterType="Pager" resultType="Long">
  		SELECT COUNT(*) FROM BOARD
  		<include refid="search"></include>
  	</select>
  	
  	<sql id="search">
  		WHERE
  			<choose>
  				<when test="kind == 'k1'">
  					BOARD_TITLE LIKE CONCAT('%', #{search}, '%') 
  				</when>
  				<when test="kind == 'k2'">
  					BOARD_CONTENTS LIKE CONCAT('%', #{search}, '%')
  				</when>
  				<otherwise>
  					BOARD_TITLE LIKE CONCAT('%', #{search}, '%') OR BOARD_CONTENTS LIKE CONCAT('%', #{search}, '%')
  				</otherwise>
  			</choose>
  		AND DELETE_STATUS = 0
  	</sql>
  	
  	<select id="getDetail" parameterType="BoardVO" resultMap="getBoardDetail">
  		SELECT * 
  		FROM BOARD A
  		LEFT OUTER JOIN 
  		(SELECT * FROM COMMENT WHERE BOARD_NUM = #{boardNum} AND DELETE_STATUS = 0 AND IS_REPLY = 0) C
  		ON A.BOARD_NUM = C.BOARD_NUM
  		WHERE A.BOARD_NUM = #{boardNum}
  	</select>
  	
  	<resultMap type="BoardVO" id="getBoardDetail">
  		<id column="Board_NUM" property="boardNum"/>
  		<result column="BOARD_TITLE" property="boardTitle"/>
  		<result column="USER_ID" property="userId"/>
  		<result column="BOARD_CONTENTS" property="boardContents"/>
  		<result column="BOARD_DATE" property="boardDate"/>
  		<result column="BOARD_HIT" property="boardHit"/>
  		<result column="UPDATE_DATE" property="updateDate"/>
  		
  		<collection property="comments" javaType="java.util.List" ofType="CommentVO" notNullColumn="COMMENT_NUM">
  			<id column="COMMENT_NUM" property="commentNum"/>
  			<result column="BOARD_NUM" property="boardNum"/>
  			<result column="USER_ID" property="userId"/>
  			<result column="COMMENT_CONTENTS" property="commentContents"/>
  			<result column="COMMENT_P" property="commentP"/>
  			<result column="COMMENT_DATE" property="commentDate"/>
  			<result column="IS_REPLY" property="isReply"/>
  		</collection>
  	</resultMap>
  	
  	<select id="detailComment" parameterType="CommentVO" resultType="CommentVO">
  		SELECT * FROM COMMENT WHERE COMMENT_NUM = #{commentNum}
  	</select>
  	
  	<select id="replyDetail" parameterType="CommentVO" resultType="CommentVO">
  		SELECT * FROM COMMENT WHERE COMMENT_NUM = #{commentNum}
  	</select>
  	
  	<select id="replyList" parameterType="CommentVO" resultType="CommentVO">
  		SELECT * FROM COMMENT WHERE COMMENT_P = #{commentNum} AND IS_REPLY = 1 ORDER BY COMMENT_DATE DESC
  	</select>
  	
	<update id="delete" parameterType="BoardVO">
		UPDATE BOARD SET DELETE_STATUS = 1 WHERE BOARD_NUM = #{boardNum}
	</update>
	
	<update id="update" parameterType="BoardVO">
		UPDATE BOARD SET BOARD_TITLE = #{boardTitle}, BOARD_CONTENTS = #{boardContents} WHERE BOARD_NUM = #{boardNum}
	</update>
	
	<update id="refInit" parameterType="CommentVO">
		UPDATE COMMENT SET COMMENT_REF = #{commentNum} WHERE COMMENT_NUM = #{commentNum}
	</update>
	
	<update id="updateStep" parameterType="CommentVO">
		UPDATE COMMENT SET COMMENT_STEP = COMMENT_STEP + 1 WHERE COMMENT_REF = #{commentRef} AND COMMENT_STEP > #{commentStep}
	</update>
  </mapper>
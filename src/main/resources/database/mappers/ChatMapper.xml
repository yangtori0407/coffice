<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="com.coffice.app.chat.ChatDAO">
  	<select id="getRoomList" resultType="ChatRoomVO">
  		SELECT CHATROOM_NUM, CHATROOM_NAME, CHATROOM_DATE FROM CHAT_ROOM
  	</select>
  	
  	<select id="getCreatorRoomList" parameterType="UserVO" resultType="java.lang.String">
  		SELECT CHATROOM_NUM FROM CHAT_ROOM WHERE CHATROOM_CREATOR = #{userId}
  	</select>
  	
  	<select id="getRoomUsers" parameterType="java.lang.String" resultType="java.lang.String">
  		SELECT USER_ID FROM CHAT_PERSON WHERE CHATROOM_NUM = #{room}
  	</select>
  	
  	<select id="getList" parameterType="UserVO" resultType="ChatRoomVO">
  		SELECT R.CHATROOM_NUM, R.CHATROOM_NAME 
  		FROM CHAT_ROOM R 
  		JOIN CHAT_PERSON P 
  		ON R.CHATROOM_NUM = P.CHATROOM_NUM 
  		WHERE P.USER_ID = #{userId} 
  		ORDER BY P.LAST_READ_AT DESC
  	</select>
  	
  	<select id="getChatInfo" parameterType="ChatRoomVO" resultType="ChatRoomVO">
  		SELECT CHATROOM_NAME, CHATROOM_NUM FROM CHAT_ROOM WHERE CHATROOM_NUM = #{chatRoomNum}
  	</select>
  	
  	<select id="getContentsInfo" parameterType="ChatContentsVO" resultType="ChatContentsVO">
  		SELECT CHAT_NUM, CHATROOM_NUM, CHAT_CONTENTS, SEND_DATE, SENDER
  		FROM CHAT_CONTENTS
  		WHERE CHAT_NUM = #{chatNum}
  	</select>
  	
  	<select id="getChatContentsList" parameterType="ChatContentsVO" resultType="ChatContentsVO">
  		SELECT CHAT_NUM, CHATROOM_NUM, CHAT_CONTENTS, SEND_DATE, SENDER
  		FROM CHAT_CONTENTS
  		WHERE CHATROOM_NUM = #{chatRoomNum}
  	</select>
  	
  	<insert id="addChat" parameterType="ChatRoomVO" useGeneratedKeys="true" keyProperty="chatRoomNum">
  		INSERT INTO CHAT_ROOM VALUES(#{chatRoomNum}, #{chatRoomName}, now(), #{chatRoomCreator})
  	</insert>
  	
  	<insert id="addUser" parameterType="ChatAddVO">
  		INSERT INTO CHAT_PERSON(CHATROOM_NUM, USER_ID, JOINED_AT, LAST_READ_AT) VALUES
  		<foreach collection="users" item="u" separator=",">
  			(#{chatRoomNum}, #{u}, now(), null)
  		</foreach>
  	</insert>
  	
  	<insert id="addContents" parameterType="ChatContentsVO" useGeneratedKeys="true" keyProperty="chatNum">
  		INSERT INTO CHAT_CONTENTS(CHAT_NUM, CHATROOM_NUM, CHAT_CONTENTS, SEND_DATE, SENDER)
  		VALUES (NULL, #{chatRoomNum}, #{chatContents}, now(), #{sender})
  	</insert>
  	
  	
</mapper>
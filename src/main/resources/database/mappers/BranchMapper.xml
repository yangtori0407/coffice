<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.coffice.app.branch.BranchDAO">
  	<sql id="search">
  		WHERE
  		<choose>
  			<when test="kind == 'k1'">
  				BRANCH_NAME
  			</when>
  			<when test="kind == 'k2'">
  				BRANCH_STATUS
  			</when>
  			<otherwise>
  				BRANCH_ADDRESS
  			</otherwise>
  		</choose>
  		LIKE CONCAT('%',#{search},'%')
  	</sql>
  
  	<select id="getList" resultType="BranchVO" parameterType="Pager">
  		SELECT * FROM BRANCH
  		<include refid="search"></include>
  	</select>
  	
  	<select id="notAddBranchList" resultType="BranchVO">
  		SELECT * FROM BRANCH WHERE USER_ID IS NULL
  	</select>
  	
  	<select id="notAddBranchMasterList" resultMap="getBranchMaster">
  		SELECT * 
  		FROM USERS 
			JOIN BRANCHMASTER
			USING(USER_ID)
  		WHERE ADD_TYPE=0
  	</select>
  	
  	<insert id="add" parameterType="BranchVO">
  		INSERT INTO BRANCH
  		VALUES(null, #{branchName},#{branchAddress},#{branchPostcode},0,null)
  	</insert>
  	
  	<update id="branchUpdate" parameterType="BranchVO">
  		UPDATE BRANCH SET USER_ID=#{userId} WHERE BRANCH_ID=#{branchId}
  	</update>
  	
  	<select id="getDetail" resultMap="getBranch" parameterType="BranchVO">
  		SELECT * 
		  FROM BRANCH 
			LEFT OUTER JOIN USERS
			USING(USER_ID)
		  WHERE BRANCH_ID =#{branchId}
  	</select>
  
  <resultMap type="BranchMasterVO" id="getBranchMaster">
	  	<result column="CONTACT_NUMBER" property="contactNumber"/>
	  	<result column="CONTACT_DATE" property="contactDate"/>
	  	<result column="ADD_TYPE" property="addType"/>
  	
	  	<association property="userId" javaType="UserVO">
			<id column="USER_ID" property="userId"/>
			<result column="PASSWORD" property="password"/>
			<result column="NAME" property="name"/>
			<result column="POSITION" property="position"/>
			<result column="HIRE_DATE" property="hireDate"/>
			<result column="HIRE_TYPE" property="hireType"/>
			<result column="BIRTH_DATE" property="birthDate"/>
			<result column="PHONE" property="phone"/>
			<result column="EMAIL" property="email"/>
			<result column="STATUS" property="status"/>
			<result column="RESIGN_DATE" property="resignDate"/>
			<result column="SAVE_NAME" property="saveName"/>
			<result column="ORIGIN_NAME" property="originName"/>
			<result column="DEPT_ID" property="deptId"/>
	  	</association>
	</resultMap>
	
	<resultMap type="BranchVO" id="getBranch">
		<id column="BRANCH_ID" property="branchId"/>
		<result column="BRANCH_NAME" property="branchName"/>
		<result column="BRANCH_ADDRESS" property="branchAddress"/>
		<result column="BRANCH_POSTCODE" property="branchPostcode"/>
		<result column="BRANCH_STATUS" property="branchStatus"/>
		<result column="USER_ID" property="userId"/>
	
		<association property="userVO" javaType="UserVO">
			<result column="PASSWORD" property="password"/>
			<result column="NAME" property="name"/>
			<result column="POSITION" property="position"/>
			<result column="HIRE_DATE" property="hireDate"/>
			<result column="HIRE_TYPE" property="hireType"/>
			<result column="BIRTH_DATE" property="birthDate"/>
			<result column="PHONE" property="phone"/>
			<result column="EMAIL" property="email"/>
			<result column="STATUS" property="status"/>
			<result column="RESIGN_DATE" property="resignDate"/>
			<result column="SAVE_NAME" property="saveName"/>
			<result column="ORIGIN_NAME" property="originName"/>
			<result column="DEPT_ID" property="deptId"/>
		</association>
	</resultMap>
  </mapper>